<!DOCTYPE html>
<html>
<head>
  <title>Last Plate ‚Äì Nearby Food</title>

  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: #0b0f14;
      color: #e5e7eb;
    }

    .hero {
      height: 280px;
      background-image: url("https://images.unsplash.com/photo-1528605248644-14dd04022da1?q=80&w=1920&auto=format&fit=crop");
      background-size: cover;
      background-position: center;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        rgba(5, 8, 15, 0.85),
        rgba(5, 8, 15, 0.95)
      );
    }

    .hero-content {
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .container {
      max-width: 1100px;
      margin: -40px auto 40px;
      padding: 0 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 22px;
      z-index: 2;
    }

    .card {
      border-radius: 18px;
      padding: 18px;
      background-size: cover;
      background-position: center;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
    }

    .card-content {
      position: relative;
      z-index: 1;
    }

    .price { color:#4ade80; font-size:22px; font-weight:700; }

    button {
      width:100%;
      padding:12px;
      border-radius:14px;
      border:none;
      background:#22c55e;
      font-weight:600;
      cursor:pointer;
    }

    /* MODAL */
    #qtyModal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      z-index:999;
    }

    #qtyModal .box {
      background:#0b0f14;
      width:320px;
      margin:15% auto;
      padding:20px;
      border-radius:14px;
    }
  </style>
</head>

<body>

<section class="hero">
  <div class="hero-content">
    <h1>üçΩÔ∏è Fud Edkate</h1>
    <p>Late nights. Fresh food. Zero waste.</p>
  </div>
</section>

<div class="container" id="foodList"></div>

<!-- QUANTITY MODAL -->
<div id="qtyModal">
  <div class="box">
    <h3>Select Quantity</h3>
    <input id="qtyInput" type="number" min="1" style="width:100%;padding:10px;">
    <div id="totalPrice" style="margin:10px 0;font-weight:600;"></div>

    <button onclick="confirmQuantity()">Continue</button>
    <button onclick="closeModal()" style="margin-top:8px;background:none;color:#aaa;">Cancel</button>
  </div>
</div>

<script>
let selectedFoodId = null;
let unitPrice = 0;
let maxQty = 0;

function openQuantityModal(foodId, availableQty, price) {
  selectedFoodId = foodId;
  unitPrice = price;
  maxQty = availableQty;

  const qty = document.getElementById("qtyInput");
  qty.value = 1;
  qty.max = availableQty;

  updateTotal();
  document.getElementById("qtyModal").style.display = "block";
}

function closeModal() {
  document.getElementById("qtyModal").style.display = "none";
}

function updateTotal() {
  const qty = parseInt(document.getElementById("qtyInput").value || 1);
  document.getElementById("totalPrice").innerText = `Total: ‚Çπ${qty * unitPrice}`;
}

document.getElementById("qtyInput").addEventListener("input", updateTotal);

/* THIS WAS MISSING ‚ùó */
function confirmQuantity() {
  const qty = parseInt(document.getElementById("qtyInput").value);

  if (qty < 1 || qty > maxQty) {
    alert("Invalid quantity");
    return;
  }

  fetch("/api/order/create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      food_id: selectedFoodId,
      quantity: qty
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      window.location.href = `/checkout/${data.order_id}`;
    } else {
      alert(data.message || "Failed");
    }
  });
}

/* FETCH FOODS */
fetch("/api/foods")
  .then(res => res.json())
  .then(data => {
    const list = document.getElementById("foodList");

    data.foods.forEach(food => {
      list.innerHTML += `
        <div class="card" style="background-image:url('https://images.unsplash.com/photo-1543352634-6c8e8b3a8e01')">
          <div class="card-content">
            <h3>${food.name}</h3>
            <div>${food.restaurant_name}</div>
            <div class="price">‚Çπ${food.price}</div>
            <div>Available: ${food.available_quantity}</div>
            <div>‚è≥ Closing in ${food.minutes_left} min</div>
            <button onclick="openQuantityModal(${food.id}, ${food.available_quantity}, ${food.price})">
              Reserve quietly ü§ç
            </button>
          </div>
        </div>`;
    });
  });
</script>

</body>
</html>
