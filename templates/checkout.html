<input id="email" type="email" placeholder="Enter email for OTP" required>
<input id="qty" type="number" min="1" max="{{ food.available_quantity }}" value="1">
<button id="payBtn">Pay Now</button>

<script>
document.getElementById("payBtn").onclick = function () {
  const qty = parseInt(document.getElementById("qty").value);
  const email = document.getElementById("email").value;

  if (!email) return alert("Email required");
  if (!qty || qty <= 0) return alert("Invalid quantity");

  fetch("/api/create-order", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      food_id: {{ food.id | tojson }},
      quantity: qty,
      email: email
    })
  })
  .then(res => res.json())
  .then(data => {
    const options = {
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.razorpay_order_id,
      name: "Last Plate",

      handler: function (response) {
        fetch("/api/verify-payment", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(response)
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert("Pickup OTP: " + result.pickup_otp);
            setTimeout(() => location.href = "/browse", 1500);
          } else {
            alert("Payment verification failed");
          }
        });
      }
    };
    new Razorpay(options).open();
  });
};
</script>
